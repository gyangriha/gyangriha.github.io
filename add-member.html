<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscriber Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
            <div class="mb-4">
                <label class="block text-gray-700">Username</label>
                <input id="username" type="text" class="w-full p-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700">Password</label>
                <input id="password" type="password" class="w-full p-2 border rounded">
            </div>
            <button id="loginBtn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Login</button>
            <p id="loginError" class="text-red-500 text-center mt-4 hidden">Invalid credentials</p>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="app" class="hidden">
        <div class="container mx-auto p-4">
            <h1 class="text-3xl font-bold mb-4">Subscriber Management</h1>
            <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded mb-4">Logout</button>

            <!-- Add Subscriber Form -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
                <h2 class="text-xl font-bold mb-4">Add Subscriber</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700">Name</label>
                        <input id="name" type="text" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700">Phone</label>
                        <input id="phone" type="text" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700">Date of Joining</label>
                        <input id="doj" type="date" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700">Subscription Amount</label>
                        <input id="amount" type="number" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700">Payment Mode</label>
                        <select id="paymentMode" class="w-full p-2 border rounded">
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="UPI">UPI</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700">Shift</label>
                        <select id="shift" class="w-full p-2 border rounded">
                            <option value="Morning">Morning</option>
                            <option value="Evening">Evening</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700">Notes</label>
                        <textarea id="notes" class="w-full p-2 border rounded"></textarea>
                    </div>
                </div>
                <button id="addSubscriberBtn" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Add Subscriber</button>
            </div>

            <!-- View Subscribers -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4">Subscribers</h2>
                <div class="mb-4">
                    <label class="block text-gray-700">Filter by Month</label>
                    <input id="monthFilter" type="month" class="p-2 border rounded">
                </div>
                <div class="mb-4">
                    <p>Total Subscription Amount: <span id="totalAmount">0</span></p>
                </div>
                <div class="mb-4">
                    <button id="exportPdfBtn" class="bg-green-500 text-white px-4 py-2 rounded mr-2">Export PDF</button>
                    <button id="exportCsvBtn" class="bg-green-500 text-white px-4 py-2 rounded mr-2">Export CSV</button>
                    <button id="syncGoogleSheetsBtn" class="bg-purple-500 text-white px-4 py-2 rounded">Sync with Google Sheets</button>
                </div>
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="border p-2">Name</th>
                            <th class="border p-2">Phone</th>
                            <th class="border p-2">Date of Joining</th>
                            <th class="border p-2">Amount</th>
                            <th class="border p-2">Payment Mode</th>
                            <th class="border p-2">Shift</th>
                            <th class="border p-2">Notes</th>
                            <th class="border p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="subscriberTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration (replace with your Firebase project credentials)
        
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyBMoCq5r8RKCI6jqy1m84jg2oNmSskSPVA",
          authDomain: "gyan-griha.firebaseapp.com",
          projectId: "gyan-griha",
          storageBucket: "gyan-griha.firebasestorage.app",
          messagingSenderId: "256130518162",
          appId: "1:256130518162:web:bb2b476d6862cc74a86a4b",
          measurementId: "G-G3R1KBY86R"
        };

        // Default credentials
        const defaultCredentials = { username: "Admin", password: "Avinash123" };

        // Initialize Firebase with error handling
        let db;
        try {
            if (typeof firebase === 'undefined') {
                throw new Error("Firebase SDK not loaded");
            }
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            alert("Failed to initialize Firebase. Please check your configuration and internet connection.");
        }

        // Login functionality
        document.getElementById("loginBtn").addEventListener("click", () => {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const loginError = document.getElementById("loginError");

            if (username === defaultCredentials.username && password === defaultCredentials.password) {
                document.getElementById("loginPage").classList.add("hidden");
                document.getElementById("app").classList.remove("hidden");
                if (db) renderSubscribers();
                else alert("Database not initialized. Please refresh and try again.");
            } else {
                loginError.classList.remove("hidden");
            }
        });

        // Logout functionality
        document.getElementById("logoutBtn").addEventListener("click", () => {
            document.getElementById("loginPage").classList.remove("hidden");
            document.getElementById("app").classList.add("hidden");
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
            document.getElementById("loginError").classList.add("hidden");
        });

        // Add subscriber
        document.getElementById("addSubscriberBtn").addEventListener("click", async () => {
            if (!db) {
                alert("Database not initialized. Please refresh and try again.");
                return;
            }
            const subscriber = {
                id: Date.now().toString(),
                name: document.getElementById("name").value,
                phone: document.getElementById("phone").value,
                doj: document.getElementById("doj").value,
                amount: parseFloat(document.getElementById("amount").value) || 0,
                paymentMode: document.getElementById("paymentMode").value,
                shift: document.getElementById("shift").value,
                notes: document.getElementById("notes").value
            };

            if (subscriber.name && subscriber.phone && subscriber.doj && subscriber.amount) {
                try {
                    await db.collection("subscribers").doc(subscriber.id).set(subscriber);
                    renderSubscribers();
                    clearForm();
                } catch (error) {
                    console.error("Error adding subscriber: ", error);
                    alert("Failed to add subscriber.");
                }
            } else {
                alert("Please fill all required fields.");
            }
        });

        // Clear form
        function clearForm() {
            document.getElementById("name").value = "";
            document.getElementById("phone").value = "";
            document.getElementById("doj").value = "";
            document.getElementById("amount").value = "";
            document.getElementById("paymentMode").value = "Cash";
            document.getElementById("shift").value = "Morning";
            document.getElementById("notes").value = "";
        }

        // Render subscribers
        async function renderSubscribers() {
            if (!db) {
                alert("Database not initialized. Please refresh and try again.");
                return;
            }
            const tableBody = document.getElementById("subscriberTable");
            const monthFilter = document.getElementById("monthFilter").value;
            tableBody.innerHTML = "";

            try {
                const querySnapshot = await db.collection("subscribers").get();
                let subscribers = [];
                querySnapshot.forEach(doc => subscribers.push(doc.data()));

                let filteredSubscribers = subscribers;
                if (monthFilter) {
                    const [year, month] = monthFilter.split("-");
                    filteredSubscribers = subscribers.filter(sub => {
                        const doj = new Date(sub.doj);
                        return doj.getFullYear() === parseInt(year) && doj.getMonth() + 1 === parseInt(month);
                    });
                }

                let totalAmount = 0;
                filteredSubscribers.forEach(sub => {
                    totalAmount += sub.amount;
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td class="border p-2">${sub.name}</td>
                        <td class="border p-2">${sub.phone}</td>
                        <td class="border p-2">${sub.doj}</td>
                        <td class="border p-2">${sub.amount}</td>
                        <td class="border p-2">${sub.paymentMode}</td>
                        <td class="border p-2">${sub.shift}</td>
                        <td class="border p-2">${sub.notes}</td>
                        <td class="border p-2">
                            <button onclick="editSubscriber('${sub.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded mr-2">Edit</button>
                            <button onclick="deleteSubscriber('${sub.id}')" class="bg-red-500 text-white px-2 py-1 rounded">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.getElementById("totalAmount").textContent = totalAmount.toFixed(2);
            } catch (error) {
                console.error("Error fetching subscribers: ", error);
                alert("Failed to fetch subscribers.");
            }
        }

        // Edit subscriber
        async function editSubscriber(id) {
            if (!db) {
                alert("Database not initialized. Please refresh and try again.");
                return;
            }
            try {
                const doc = await db.collection("subscribers").doc(id).get();
                const subscriber = doc.data();
                if (subscriber) {
                    document.getElementById("name").value = subscriber.name;
                    document.getElementById("phone").value = subscriber.phone;
                    document.getElementById("doj").value = subscriber.doj;
                    document.getElementById("amount").value = subscriber.amount;
                    document.getElementById("paymentMode").value = subscriber.paymentMode;
                    document.getElementById("shift").value = subscriber.shift;
                    document.getElementById("notes").value = subscriber.notes;

                    await deleteSubscriber(id);
                }
            } catch (error) {
                console.error("Error editing subscriber: ", error);
                alert("Failed to edit subscriber.");
            }
        }

        // Delete subscriber
        async function deleteSubscriber(id) {
            if (!db) {
                alert("Database not initialized. Please refresh and try again.");
                return;
            }
            try {
 Forma 1:1
                await db.collection("subscribers").doc(id).delete();
                renderSubscribers();
            } catch (error) {
                console.error("Error deleting subscriber: ", error);
                alert("Failed to delete subscriber.");
            }
        }

        // Month filter
        document.getElementById("monthFilter").addEventListener("change", renderSubscribers);

        // Export to PDF
        document.getElementById("exportPdfBtn").addEventListener("click", async () => {
            if (!db) {
                alert("Database not initialized. Please refresh and try again.");
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Subscriber Report", 10, 10);
            let y = 20;

            try {
                const querySnapshot = await db.collection("subscribers").get();
                let subscribers = [];
                querySnapshot.forEach(doc => subscribers.push(doc.data()));

                subscribers.forEach((sub, index) => {
                    doc.text(
                        `${index + 1}. ${sub.name}, ${sub.phone}, ${sub.doj}, ${sub.amount}, ${sub.paymentMode}, ${sub.shift}, ${sub.notes}`,
                        10,
                        y
                    );
                    y += 10;
                });
                doc.save("subscribers.pdf");
            } catch (error) {
                console.error("Error exporting PDF: ", error);
                alert("Failed to export PDF.");
            }
        });

        // Export to CSV
        document.getElementById("exportCsvBtn").addEventListener("click", async () => {
            if (!db) {
                alert("Database not initialized. Please refresh and try again.");
                return;
            }
            try {
                const querySnapshot = await db.collection("subscribers").get();
                let subscribers = [];
                querySnapshot.forEach(doc => subscribers.push(doc.data()));

                const csv = Papa.unparse(subscribers);
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "subscribers.csv";
                link.click();
            } catch (error) {
                console.error("Error exporting CSV: ", error);
                alert("Failed to export CSV.");
            }
        });

        // Google Sheets Sync (Optional)
        document.getElementById("syncGoogleSheetsBtn").addEventListener("click", () => {
            alert(
                "To sync with Google Sheets, you need to authorize access via Google API. " +
                "Please set up a Google Cloud project, enable the Sheets API, and obtain an OAuth 2.0 Client ID. " +
                "Then, use the Google API client library to authenticate and sync data."
            );
        });
    </script>
</body>
</html>